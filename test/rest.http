#@folio = http://localhost:5000
@folio = http://localhost:8000
#@folio = https://folio-staging.openup.org.za
@keycloak = http://keycloak.local
# @keycloak = https://keycloak-staging.openup.org.za
# @keycloak = http://localhost:8080


@realm = agari
@client_id = dms
@client_secret = VDyLEjGR3xDQvoQlrHq5AB6OwbW0Refc

@username = system.admin@agari.tech
#@username = owner@org1.ac.za
# @username = owner@org2.ac.za
# @username = org-admin@org1.ac.za
# @username = org-admin@org2.ac.za
# @username = test-user1@example.com
# @username = test-user2@example.com
# @username = test-user3@example.com


@password = pass123

### 1. LOGIN to get access token
# @name login
POST {{keycloak}}/realms/{{realm}}/protocol/openid-connect/token
Content-Type: application/x-www-form-urlencoded

username={{username}}
&password={{password}}
&grant_type=password
&client_id={{client_id}}
&client_secret={{client_secret}}

###
@token = {{login.response.body.access_token}}


### Keycloak generate magic link
@redirect_uri = https://agari.openup.org.za
# @name magiclink
POST {{keycloak}}/realms/{{realm}}/magic-link
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "email": "michael@openup.org.za",
  "client_id": "dms",
  "redirect_uri": "https://agari.openup.org.za",
  "expiration_seconds": 3600,
  "send_email": false
}

### Keycloak authenticate with code
POST {{keycloak}}/realms/agari/protocol/openid-connect/token
Content-Type: application/x-www-form-urlencoded

client_id={{client_id}}
&client_secret={{client_secret}}
&grant_type=authorization_code
&code=[add code here]
&redirect_uri={{redirect_uri}}

##########################
### INFO
##########################

# @name health
GET {{folio}}/info/health

###

# @name databaseHealth
GET {{folio}}/info//health/db

###

# @name whoami
GET {{folio}}/info/whoami
Authorization: Bearer {{token}}

###

# @name permissions
GET {{folio}}/info/permissions
Authorization: Bearer {{token}}

###

# @name userHasResourcePermission

POST {{folio}}/info/permissions/check
Authorization: Bearer {{token}}
Content-Type: application/json

{
    "permission": "create_project",
    "resource_type": "project",
    "resource_id": "80bd4fd2-10e3-4104-abe2-713dfdd92bfa"
}


###

# @name permission_check
POST {{folio}}/info/permissions/check
Authorization: Bearer {{token}}
Content-Type: application/json

{
    "permission": "view_org_private_projects",
    "resource_type": "project",
    "resource_id": "80bd4fd2-10e3-4104-abe2-713dfdd92bfa"
}

##########################
### PATHOGENS
##########################

# @name list_pathogens
GET {{folio}}/pathogens

###

# @name list_pathogens_deleted
GET {{folio}}/pathogens?deleted=true

###

# @name create_pathogen
POST {{folio}}/pathogens
Authorization: Bearer {{token}}
Content-Type: application/json

{
    "name": "Cholera4",
    "description": "Cholera Virus4",
    "scientific_name": "Vibrio cholerae4"
}

###
@pathogen_id = {{create_pathogen.response.body.pathogen.id}}
#@pathogen_id = 0683f0f6-04b3-4005-a078-383d0e3e88f2

# @name get_pathogen
GET {{folio}}/pathogens/{{pathogen_id}}

###

# @name delete_pathogen
DELETE {{folio}}/pathogens/{{pathogen_id}}
Authorization: Bearer {{token}}

###

# @name delete_pathogen_hard
DELETE {{folio}}/pathogens/{{pathogen_id}}?hard=true
Authorization: Bearer {{token}}

###

# @update_pathogen
PUT {{folio}}/pathogens/{{pathogen_id}}
Authorization: Bearer {{token}}
Content-Type: application/json

{
    "name": "Cholera",
    "description": "Cholera virus",
    "scientific_name": "Vibrio cholerae"
}

###

# @name restore_pathogen
POST {{folio}}/pathogens/{{pathogen_id}}/restore
Authorization: Bearer {{token}}

##########################
### PROJECTS
##########################

# @name list_projects
GET {{folio}}/projects
Authorization: Bearer {{token}}

###

# @name create_project
POST {{folio}}/projects
Authorization: Bearer {{token}}
Content-Type: application/json

{
    "name": "Cholera Project2",
    "description": "Project description2",
    "pathogen_id": "{{pathogen_id}}",
    "privacy": "public"
}

###

@project_id = {{create_project.response.body.project.id}}
# @project_id = cc99173f-c585-4ac3-8a36-2178d52181ec

### @name get_project
GET {{folio}}/projects/{{project_id}}
Authorization: Bearer {{token}}

###

# @name update_project
PUT {{folio}}/projects/{{project_id}}
Authorization: Bearer {{token}}
Content-Type: application/json

{
    "privacy": "private"
}

###

# @name delete_project
DELETE {{folio}}/projects/{{project_id}}
Authorization: Bearer {{token}}

###

# @name delete_project_hard
DELETE {{folio}}/projects/{{project_id}}?hard=true
Authorization: Bearer {{token}}

###

# @name restore_project
POST {{folio}}/projects/{{project_id}}/restore
Authorization: Bearer {{token}}

##########################
### PROJECT USERS
##########################

# @name list_project_users
GET {{folio}}/projects/{{project_id}}/users
Authorization: Bearer {{token}}

###

# @name add_project_users
POST {{folio}}/projects/{{project_id}}/users
Authorization: Bearer {{token}}
Content-Type: application/json

{
    "user_id": "282dd9ee-ad7e-4580-9677-fa37d7ba6435",
    "role": "project-contributor"
}

###

@user_id = 638e2410-c4cf-4854-8258-d600ac289bcc

# @name delete_project_users
DELETE {{folio}}/projects/{{project_id}}/users/{{user_id}}
Authorization: Bearer {{token}}


##########################
### STUDIES
##########################

# @name list_studies
GET {{folio}}/studies
Authorization: Bearer {{token}}

###

@study_id = study-003

# @name create_study
POST {{folio}}/studies/
Authorization: Bearer {{token}}
Content-Type: application/json

{
    "studyId": "{{study_id}}",
    "name": "AGARI Test Study", 
    "description": "Test study for genomic data workflow",
    "projectId": "{{project_id}}",
    "info": {
        "projectType": "genomics",
        "region": "South Africa"
    }
}

### 

# @name get_studies_in_song
GET http://song.local/studies/all
Authorization: Bearer {{token}}

###

# @name create_study_in_song
POST http://song.local/studies/{{study_id}}/
Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJLa0g4OUtCZV9lQTE4dk45RHpvSEpLOHFIWWhIS0g1UEFUby1XNTE1cFB3In0.eyJleHAiOjE3NjE0MzIxNjIsImlhdCI6MTc2MTQzMTg2MiwianRpIjoidHJydGNjOmI4ODYxYmU4LTRhMzAtNDJjZS04YTc0LWIzMDAyY2ZiYWY3YyIsImlzcyI6Imh0dHA6Ly9rZXljbG9hay5sb2NhbC9yZWFsbXMvYWdhcmkiLCJhdWQiOiJyZWFsbS1tYW5hZ2VtZW50Iiwic3ViIjoic2VydmljZS1hY2NvdW50LWRtcy1pZCIsInR5cCI6IkJlYXJlciIsImF6cCI6ImRtcyIsInJlYWxtX2FjY2VzcyI6eyJyb2xlcyI6WyJzeXN0ZW0tYWRtaW4iLCJyZWFsbS1hZG1pbiIsInVtYV9hdXRob3JpemF0aW9uIl19LCJyZXNvdXJjZV9hY2Nlc3MiOnsicmVhbG0tbWFuYWdlbWVudCI6eyJyb2xlcyI6WyJ2aWV3LXJlYWxtIiwidmlldy1pZGVudGl0eS1wcm92aWRlcnMiLCJtYW5hZ2Utb3JnYW5pemF0aW9ucyIsIm1hbmFnZS1pZGVudGl0eS1wcm92aWRlcnMiLCJpbXBlcnNvbmF0aW9uIiwicmVhbG0tYWRtaW4iLCJjcmVhdGUtY2xpZW50IiwibWFuYWdlLXVzZXJzIiwicXVlcnktcmVhbG1zIiwicHVibGlzaC1ldmVudHMiLCJ2aWV3LWF1dGhvcml6YXRpb24iLCJxdWVyeS1jbGllbnRzIiwicXVlcnktdXNlcnMiLCJtYW5hZ2UtZXZlbnRzIiwibWFuYWdlLXJlYWxtIiwidmlldy1vcmdhbml6YXRpb25zIiwidmlldy1ldmVudHMiLCJ2aWV3LXVzZXJzIiwidmlldy1jbGllbnRzIiwibWFuYWdlLWF1dGhvcml6YXRpb24iLCJtYW5hZ2UtY2xpZW50cyIsInF1ZXJ5LWdyb3VwcyJdfSwiZG1zIjp7InJvbGVzIjpbInVtYV9wcm90ZWN0aW9uIl19fSwic2NvcGUiOiJlbWFpbCBwcm9maWxlIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInByZWZlcnJlZF91c2VybmFtZSI6InNlcnZpY2UtYWNjb3VudC1kbXMifQ.V7Cz6w6TjdZcWNmFhxM2DU5lJSb_2f0PduJ8vOjJbCi-3IjF-ZTCyNW8fj4x9FVfuJUvQ4g9yBW0ON6Q5c_z1XtYk7F2QAPG2GT9NK9y_cEz1rwh7lhtwCSaDC2UTrPXbADa6L7JfLIbHlgtyT1pqyw4azLdoPwXSgZ6J7sysrsL7XkTgCoMoieILDTDvlmRMwPf27qZ4e9D6NalZtwuYR-nq1rpT7RGMaqeDe0K6CSvH-o0alxtTaq-KS28vc0JTjHMY3qW6ttmbWTf45UM_s_Z-G-Uua65MzQebC4TkVFQCfYWBayv0Q1xcPqSdYrWFg3N25f4mQRVdS30yJVzBA
Content-Type: application/json

{
    "studyId": "{{study_id}}",
    "name": "name",
    "description": "description",
    "info": {}
}

###

# @name get_study_in_song
GET http://song.local/studies/{{study_id}}
Authorization: Bearer {{token}}

###

# @name submitAnalysis
POST {{folio}}/studies/submit/{{study_id}}/
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "studyId": "study-003",
  "analysisId": "analysis001",
  "analysisType": {
    "name": "sequencingRead",
    "version": 1
  },
  "samples": [
    {
      "sampleId": "SA001",
      "submitterSampleId": "SA001",
      "sampleType": "Total DNA",
      "matchedNormalSubmitterSampleId": null,
      "specimen": {
        "specimenId": "SP001", 
        "submitterSpecimenId": "SP001",
        "specimenType": "Normal",
        "specimenTissueSource": "Blood derived",
        "tumourNormalDesignation": "Normal"
      },
      "donor": {
        "studyId": "study-003",
        "donorId": "D001",
        "submitterDonorId": "D001",
        "gender": "Female"
      }
    }
  ],
  "files": [
    {
      "fileName": "test_data.fasta",
      "fileType": "FASTA",
      "fileSize": 298,
      "fileMd5sum": "cc70b8e811b39c98a938edf87145e34d",
      "fileAccess": "open",
      "dataType": "Sequencing Reads"
    }
  ],
  "experiment": {
    "libraryStrategy": "WGS",
    "pairedEnd": false,
    "aligned": false
  }
}

###

@analysis_id = f1646e21-6c01-4f09-a46e-216c01af09d6

# @name list_study_analyses
GET http://song.local/studies/{{study_id}}/analysis?analysisStates=PUBLISHED,UNPUBLISHED
Authorization: Bearer {{token}}

###

# @name get_study_analyses
GET http://song.local/{{study_id}}/analysis/{{analysis_id}}
Authorization: Bearer {{token}}

###

# @name upload_analysis_file_curl
curl -X POST http://song.local/studies/study-002/analysis/f1646e21-6c01-4f09-a46e-216c01af09d6/upload -H "Authorization: Bearer {{token}}" -F "object_id=14e5f58a-73ed-5359-8101-e3ae6d544fbc" -F "overwrite=true" -F "file=@/home/dimee/Work/OpenUp/SANBI/agari-folio/test/test_data.fasta"

###

@object_id_from_analysis = 2966b6aa-7570-53a5-9392-740bd61221d5

# @name upload_analysis_file_rest
POST {{folio}}/studies/{{study_id}}/analysis/{{analysis_id}}/upload
Authorization: Bearer {{token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary123

------WebKitFormBoundary123
Content-Disposition: form-data; name="object_id"

{{object_id_from_analysis}}
------WebKitFormBoundary123
Content-Disposition: form-data; name="overwrite"

true
------WebKitFormBoundary123
Content-Disposition: form-data; name="file"; filename="test_data.fasta"
Content-Type: text/plain

< /media/michael/Data4/sanbi/agari-folio/test/test_data.fasta

------WebKitFormBoundary123--
###

# @name publish_analysis
POST {{folio}}/studies/{{study_id}}/analysis/publish/{{analysis_id}}
Authorization: Bearer {{token}}

### Get user by email
# @name getUserByEmail
GET {{keycloak}}/admin/realms/{{realm}}/users?email=michael@openup.org.za
Authorization: Bearer {{token}}

###
@user_id = 9af85893-2402-4069-95ef-16045ab5a77f

### Keycloak update user details
PUT {{keycloak}}/admin/realms/{{realm}}/users/{{user_id}}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "firstName": "Michael"
}

### Create new user in Keycloak
# @name createUser
POST {{keycloak}}/admin/realms/{{realm}}/users
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "username": "newuser@example.com",
  "email": "newuser@example.com",
  "enabled": false,
  "attributes": {
    "invite": ["sent"]
  }
}

### Create new user in Folio magic link
# @name createUserMagicLink
POST {{folio}}/users/
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "email": "michael@openup.org.za",
  "redirect_uri": "https://agari.openup.org.za/",
  "send_email": "false"
}


##########################
### TEMPLATES
##########################

# @name list_templates
GET {{folio}}/templates

###

# @name create_template
PUT {{folio}}/templates/
Authorization: Bearer {{token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary123

------WebKitFormBoundary123
Content-Disposition: form-data; name="pathogen_id"

{{pathogen_id}}
------WebKitFormBoundary123
Content-Disposition: form-data; name="schema_version"

1
------WebKitFormBoundary123
Content-Disposition: form-data; name="file"; filename="template_v1.xlsx"
Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet

< ./test_template.xlsx
------WebKitFormBoundary123--

###
@template_id = {{create_template.response.body.template.id}}

# @name download_template
GET {{folio}}/templates/{{template_id}}/download

###

# @name update_template
PUT {{folio}}/templates/
Authorization: Bearer {{token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary456

------WebKitFormBoundary456
Content-Disposition: form-data; name="pathogen_id"

{{pathogen_id}}
------WebKitFormBoundary456
Content-Disposition: form-data; name="schema_version"

1
------WebKitFormBoundary456
Content-Disposition: form-data; name="file"; filename="template_v1_updated.xlsx"
Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet

< ./test_template.xlsx
------WebKitFormBoundary456--
